---
- platform: zwift
  username: !secret moritz_zwift_username
  password: !secret moritz_zwift_password
  players:
    - !secret julia_zwift_id

- platform: github
  access_token: !secret github_access_token
  repositories:
    - path: 'boxcee/homeassistant'
    - path: 'mathieudutour/github-tag-action'

- platform: history_stats
  name: Time @ Home Moritz
  entity_id: person.moritz
  state: "home"
  type: ratio
  duration:
    days: 14
  end: "{{ now() }}"

- platform: history_stats
  name: Time @ Home Julia
  entity_id: person.julia
  state: "home"
  type: ratio
  duration:
    days: 14
  end: "{{ now() }}"

- platform: history_stats
  name: TV
  entity_id: media_player.tv
  state: "on"
  type: time
  duration:
    days: 14
  end: "{{ now() }}"

- platform: history_stats
  name: Soundtouch Living Room
  entity_id: media_player.soundtouch_living_room
  state: "playing"
  type: time
  duration:
    days: 14
  end: "{{ now() }}"

# - platform: here_travel_time
#   name: Julia Work
#   api_key: !secret here_travel_api_key
#   origin_entity_id: person.julia
#   destination_entity_id: zone.work_julia
#   mode: bicycle
#
# - platform: here_travel_time
#   name: Moritz Work
#   api_key: !secret here_travel_api_key
#   origin_entity_id: person.moritz
#   destination_entity_id: zone.work_moritz
#   mode: bicycle

- platform: fitbit
  clock_format: 24H
  monitored_resources:
    - activities/activityCalories
    - activities/calories
    - activities/caloriesBMR
    - activities/distance
    - activities/elevation
    - activities/floors
    - activities/heart
    - activities/minutesFairlyActive
    - activities/minutesLightlyActive
    - activities/minutesSedentary
    - activities/minutesVeryActive
    - activities/steps
    - activities/tracker/activityCalories
    - activities/tracker/calories
    - activities/tracker/distance
    - activities/tracker/elevation
    - activities/tracker/floors
    - activities/tracker/minutesFairlyActive
    - activities/tracker/minutesLightlyActive
    - activities/tracker/minutesSedentary
    - activities/tracker/minutesVeryActive
    - activities/tracker/steps
    - body/bmi
    - body/fat
    - body/weight
    - devices/battery
    - sleep/awakeningsCount
    - sleep/efficiency
    - sleep/minutesAfterWakeup
    - sleep/minutesAsleep
    - sleep/minutesAwake
    - sleep/minutesToFallAsleep
    - sleep/startTime
    - sleep/timeInBed

# Zwift

- platform: history_stats
  name: Off Zwift
  entity_id: sensor.zwift_power_zone
  state: 'Off'
  type: time
  duration:
    days: 14
  end: "{{ now() }}"

- platform: history_stats
  name: Active Recovery Zwift
  entity_id: sensor.zwift_power_zone
  state: 'Active Recovery'
  type: time
  duration:
    days: 14
  end: "{{ now() }}"

- platform: history_stats
  name: Endurance Zwift
  entity_id: sensor.zwift_power_zone
  state: 'Endurance'
  type: time
  duration:
    days: 14
  end: "{{ now() }}"

- platform: history_stats
  name: Tempo Zwift
  entity_id: sensor.zwift_power_zone
  state: 'Tempo'
  type: time
  duration:
    days: 14
  end: "{{ now() }}"

- platform: history_stats
  name: Threshold Zwift
  entity_id: sensor.zwift_power_zone
  state: 'Threshold'
  type: time
  duration:
    days: 14
  end: "{{ now() }}"

- platform: history_stats
  name: VO2 Max Zwift
  entity_id: sensor.zwift_power_zone
  state: 'VO2 Max'
  type: time
  duration:
    days: 14
  end: "{{ now() }}"

- platform: history_stats
  name: Anaerobic Capacity Zwift
  entity_id: sensor.zwift_power_zone
  state: 'Anaerobic capacity'
  type: time
  duration:
    days: 14
  end: "{{ now() }}"

- platform: history_stats
  name: Neuromuscular Power Zwift
  entity_id: sensor.zwift_power_zone
  state: 'Neuromuscular Power'
  type: time
  duration:
    days: 14
  end: "{{ now() }}"

- platform: template
  sensors:
    zwift_ftp:
      friendly_name: "Zwift FTP"
      entity_id: sensor.zwift_online_469164
      unit_of_measurement: 'watts'
      value_template: "{{states.sensor.zwift_online_469164.attributes.ftp}}"

    zwift_power_zone:
      friendly_name: "Zwift Power Zone"
      entity_id: sensor.zwift_power_469164
      value_template: >-
        {% set ftp = states('sensor.zwift_ftp') | float %}
        {% set power = states('sensor.zwift_power_469164') | float %}
        {% set zone1 = ftp | float * 0.55 %}
        {% set zone2 = ftp | float * 0.76 %}
        {% set zone3 = ftp | float * 0.90 %}
        {% set zone4 = ftp | float * 1.05 %}
        {% set zone5 = ftp | float * 1.2 %}
        {% set zone6 = ftp | float * 1.5 %}

        {% if power < 1 %}Off
        {% elif zone1 > power %}Active Recovery
        {% elif zone2 > power %}Endurance
        {% elif zone3 > power %}Tempo
        {% elif zone4 > power %}Threshold
        {% elif zone5 > power %}VO2 Max
        {% elif zone6 > power %}Anaerobic capacity
        {% elif zone6 < power %}Neuromuscular Power{% endif %}

# Aquaponics

- platform: history_stats
  name: Aquaponics Plug Count
  entity_id: switch.outdoor_plug_on_off
  state: 'on'
  type: count
  duration:
    hours: 1
  end: "{{ now() }}"

# Crypto

- platform: rest
  name: Ether Nanopool
  resource: !secret eth_balance
  method: GET
  value_template: '{{ value_json.data | float }}'
  unit_of_measurement: 'ETH'

- platform: rest
  name: Ether Wallet
  resource: !secret etherscan
  value_template: '{{ value_json.result | float / 1000000000000000000 }}'
  unit_of_measurement: 'ETH'

- platform: rest
  name: Eth Avg Hashrate
  resource: !secret eth_avghashratelimited
  method: GET
  value_template: '{{ value_json.data }}'
  unit_of_measurement: 'Mh/s'

- platform: rest
  name: Eth Approximated Earnings
  resource_template: https://api.nanopool.org/v1/eth/approximated_earnings/{{ states('sensor.eth_avg_hashrate') }}
  method: GET
  json_attributes_path: "$.data.prices"
  json_attributes:
    - price_eur
  value_template: '{{ value_json.data.hour.euros }}'
  unit_of_measurement: '€/h'

- platform: template
  sensors:
    office_consumption_cost:
      friendly_name: Office Consumption Cost
      unit_of_measurement: "€/h"
      value_template: "{{ (states('sensor.shelly_shplg_s_b864e1_current_consumption') | float / 1000) * states('input_number.electricity_cost') | float }}"
    eth_mining_profit:
      friendly_name: Eth Mining Profit
      unit_of_measurement: "€/h"
      value_template: "{{ states('sensor.eth_approximated_earnings') | float - states('sensor.office_consumption_cost') | float }}"
    eth_nanopool_euro:
      friendly_name: Ether Nanopool Euro
      unit_of_measurement: "€"
      value_template: "{{ state_attr('sensor.eth_approximated_earnings', 'price_eur') | float * states('sensor.ether_nanopool') | float }}"
    eth_wallet_euro:
      friendly_name: Ether Wallet Euro
      unit_of_measurement: "€"
      value_template: "{{ state_attr('sensor.eth_approximated_earnings', 'price_eur') | float * states('sensor.ether_wallet') | float }}"
